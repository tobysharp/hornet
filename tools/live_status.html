<!doctype html>
<meta charset="utf-8">
<title>Hornet Initial Block Download</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root{ --bg:#0b0c0f; --panel:#12151a; --ink:#e7ecf3; --muted:#9aa8b6; --accent:#3aa3ff; --ok:#00d68f; --err:#ff5c77; }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid #1b1f27;background:#0e1116;position:sticky;top:0;z-index:5}
  header h3{margin:0;font-weight:600}
  .badge{display:inline-block;border:1px solid #223249;background:#0f1826;color:#cfe7ff;border-radius:999px;padding:2px 10px;margin-right:8px;font-size:12px}
  .btn{background:#122034;color:var(--ink);border:1px solid #223249;border-radius:8px;padding:6px 10px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  main{display:grid;grid-template-columns:360px 1fr;gap:16px;padding:16px}
  .card{background:var(--panel);border:1px solid #1b2130;border-radius:12px;padding:12px}
  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px}
  .progress{height:8px;background:#0f141c;border:1px solid #1b2230;border-radius:6px;overflow:hidden}
  .bar{height:100%;background:var(--accent);width:0%}
  #console{
    font:12px/1.45 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
    height:65vh;
    overflow:auto;            /* both directions */
    overflow-x:auto;          /* ensure horizontal scroll */
    white-space:pre;          /* no wrapping */
    background:#0f141c;border:1px solid #1b2230;border-radius:8px;padding:8px
  }
  #events{display:flex;flex-direction:column;gap:6px;max-height:30vh;overflow:auto}
  .event{font:12px;display:flex;gap:8px;align-items:center}
  .pill{border-radius:6px;padding:2px 6px;border:1px solid #223249;background:#0f1826;color:#cfe7ff}
  .pill.ok{border-color:#0b3e2e;background:#0a1a16;color:#98ffd8}
  .pill.err{border-color:#5c1f2a;background:#220a0f;color:#ff8da1}
  .muted{color:#9aa8b6}
  .num{ font-variant-numeric: tabular-nums; text-align:right; }
    .stale { opacity: 0.65; }
</style>
<header>
  <h3>Hornet Live</h3>
  <span id="phase" class="badge">Phase: —</span>
  <span id="rate" class="badge">Headers/sec: —</span>
  <span id="peers" class="badge">Peers: —</span>
  <span id="status" class="badge">SSE: connecting…</span>
  <span style="flex:1"></span>
  <button id="btnUiPause" class="btn">UI Pause</button>
    <!-- keep these if you still want process pause/resume -->
    <!-- <button id="btnPause" class="btn">Pause</button>
    <button id="btnResume" class="btn" disabled>Resume</button> -->
</header>
<main>
  <div class="card">
    <div class="kv">
    <div>Headers validated</div><div id="headers_total" class="num">—</div>
    <div>Blocks validated</div><div id="blocks_validated" class="num">—</div>
    <div>Sync Progress</div>
      <div><div class="progress"><div id="bar" class="bar"></div></div></div>
    </div>
    <div style="margin-top:10px">
      <div class="muted" style="margin-bottom:6px">Recent reliable events</div>
      <div id="events"></div>
    </div>
  </div>
  <div class="card">
    <div id="console"></div>
  </div>
</main>
<script>
  const PHASE = {0:'Headers',1:'Blocks',2:'Done'};
  const es = new EventSource('/stream');
  const statusEl = document.getElementById('status');
  const phaseEl  = document.getElementById('phase');
  const rateEl   = document.getElementById('rate');
  const peersEl  = document.getElementById('peers');
  const hEl      = document.getElementById('headers_total');
  const bEl      = document.getElementById('blocks_validated');
  const barEl    = document.getElementById('bar');
  const consoleEl= document.getElementById('console');
  const eventsEl = document.getElementById('events');
  const btnP = document.getElementById('btnPause');
  const btnR = document.getElementById('btnResume');

  // ----- UI pause (drop updates when true) -----
let uiPaused = false;
const btnUiPause = document.getElementById('btnUiPause');
btnUiPause.onclick = () => {
  uiPaused = !uiPaused;
  btnUiPause.textContent = uiPaused ? 'UI Resume' : 'UI Pause';
};

// ----- Formatting helpers -----
function fmtInt(n){ return (typeof n==='number') ? n.toLocaleString() : n; }
function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi, x)); }

// ----- Single-level staleness: mark stale if field missing in the *last* packet -----
const FIELD_MAP = {
  headers_validated: { el: hEl, fmt: fmtInt },
  // backward-compat alias (if you still send headers_total):
  headers_total:     { el: hEl, fmt: fmtInt },
  blocks_validated:  { el: bEl, fmt: fmtInt },
  peers:             { el: peersEl, fmt: (x)=>String(x), label: 'Peers: ' },
  headers_rate_hz:   { el: rateEl, fmt: (x)=>`Headers/sec: ${x.toFixed ? x.toFixed(1) : x}` },
};
let lastPacketSeen = 0;   // increments every metrics packet
const fieldSeenAt = new WeakMap(); // el -> packet index

function setField(key, val, packetId){
  const rec = FIELD_MAP[key]; if(!rec) return;
  const el  = rec.el, fmt = rec.fmt || String, prefix = rec.label || '';
  if (val != null) {
    el.textContent = prefix + fmt(val);
    el.classList.remove('stale');
    fieldSeenAt.set(el, packetId);
  }
}

function applyStalenessForPacket(packetId){
  // any registered element not seen this packet becomes stale
  const uniqEls = new Set(Object.values(FIELD_MAP).map(r=>r.el));
  uniqEls.forEach(el=>{
    const seen = fieldSeenAt.get(el);
    if (seen !== packetId) el.classList.add('stale');
  });
}

// Optional: time-based single-threshold staleness (>1s) instead of “absent in last packet”.
// Flip USE_TIME_STALENESS to true to use it instead.
const USE_TIME_STALENESS = false;
const lastTimeSeen = new WeakMap();
function touchTime(el){ lastTimeSeen.set(el, performance.now()); }
function applyTimeStaleness(){
  const now = performance.now();
  const uniqEls = new Set(Object.values(FIELD_MAP).map(r=>r.el));
  uniqEls.forEach(el=>{
    const t = lastTimeSeen.get(el) ?? -1;
    if (t < 0 || (now - t) > 1000) el.classList.add('stale'); else el.classList.remove('stale');
  });
}
setInterval(()=>{ if (USE_TIME_STALENESS) applyTimeStaleness(); }, 250);

// ----- Console buffer: keep last N lines efficiently -----
const CONSOLE_MAX_LINES = 2000;
const CONSOLE_REWRITE_INTERVAL = 50;
let consoleLines = [];
let sinceRewrite = 0;
function appendConsole(line){
  consoleLines.push(line);
  if (consoleLines.length > CONSOLE_MAX_LINES) {
    consoleLines.splice(0, consoleLines.length - CONSOLE_MAX_LINES);
  }
  // Rewrite textContent every N lines to avoid constant big string rebuilds
  if (++sinceRewrite >= CONSOLE_REWRITE_INTERVAL) {
    consoleEl.textContent = consoleLines.join('\n');
    sinceRewrite = 0;
  } else {
    // cheap append for most lines
    consoleEl.textContent += (consoleEl.textContent ? '\n' : '') + line;
  }
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

  es.onopen = () => { statusEl.textContent = 'SSE: connected'; };
  es.onerror = () => { statusEl.textContent = 'SSE: reconnecting…'; };

  function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi, x)); }
  function fmtInt(n){ return (typeof n==='number') ? n.toLocaleString() : n; }

es.addEventListener('metrics', (e)=>{
  if (uiPaused) return; // drop updates while UI is paused
  try{
    const m = JSON.parse(e.data);
    lastPacketSeen++;

    // Phase chip (not part of staleness set; update always when present)
    if ('phase' in m) {
      phaseEl.textContent = 'Phase: ' + (PHASE[m.phase] ?? m.phase);
      if (USE_TIME_STALENESS) touchTime(phaseEl);
    }

    // Preferred name is headers_validated; fall back to headers_total
    const headersVal = (m.headers_validated ?? m.headers_total);

    setField('peers', m.peers, lastPacketSeen);
    setField('headers_validated', headersVal, lastPacketSeen);
    setField('blocks_validated', m.blocks_validated, lastPacketSeen);
    if ('headers_rate_hz' in m) setField('headers_rate_hz', m.headers_rate_hz, lastPacketSeen);

    // Progress bar keeps previous width if inputs missing
    const hv = Number(headersVal);
    const bv = Number(m.blocks_validated);
    if (Number.isFinite(hv) && Number.isFinite(bv) && hv > 0) {
      const pct = Math.round(clamp(bv / Math.max(hv,1), 0, 1) * 100);
      barEl.style.width = pct + '%';
      if (USE_TIME_STALENESS) { touchTime(barEl); touchTime(hEl); touchTime(bEl); }
    }

    // Mark absent fields as stale (single-level)
    if (!USE_TIME_STALENESS) applyStalenessForPacket(lastPacketSeen);

  }catch{}
});

es.addEventListener('console', (e)=>{
  if (uiPaused) return; // drop while paused
  try{
    const j = JSON.parse(e.data);
    appendConsole(j.msg || '');
  }catch{}
});

es.addEventListener('reliable', (e)=>{
  if (uiPaused) return; // drop while paused
  try{
    const r = JSON.parse(e.data);
    const row = document.createElement('div');
    row.className = 'event';
    const kind = ['Error','Warning','Info','State'][r.kind|0] || String(r.kind);
    const pill = document.createElement('span');
    pill.className = 'pill ' + (r.kind===0 ? 'err' : (r.kind===2 ? 'ok' : ''));
    pill.textContent = kind;
    const msg = document.createElement('span');
    msg.textContent = r.msg ?? JSON.stringify(r);
    row.appendChild(pill);
    row.appendChild(msg);
    eventsEl.prepend(row);
    while (eventsEl.children.length > 50) eventsEl.removeChild(eventsEl.lastChild);
  }catch{}
});

  // Pause/Resume buttons
  btnP.onclick = async () => {
    btnP.disabled = true;
    try { await fetch('/api/pause',{method:'POST'}); }
    finally { btnR.disabled = false; }
  };
  btnR.onclick = async () => {
    btnR.disabled = true;
    try { await fetch('/api/resume',{method:'POST'}); }
    finally { btnP.disabled = false; }
  };
</script>
